/*
 * HMAC Test Vectors
 *   by deadcafe.beef
 */
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdint.h>
#include <unistd.h>

#include "handler.h"

/*
 * https://tools.ietf.org/html/rfc2202
 */
/*
  test_case =     1
  key =           0x0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b
  key_len =       20
  data =          "Hi There"
  data_len =      8
  digest =        0xb617318655057264e28bc0b6fb378c8ef146be00
*/
static const uint8_t xxx_SHA1_1_key[] = {
        0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b,
        0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b,
        0x0b, 0x0b, 0x0b, 0x0b,
};

static const uint8_t xxx_SHA1_1_text[8] = "Hi There";

static const uint8_t xxx_SHA1_1_hash[] = {
        0xb6, 0x17, 0x31, 0x86, 0x55, 0x05, 0x72, 0x64,
        0xe2, 0x8b, 0xc0, 0xb6, /* 0xfb, 0x37, 0x8c, 0x8e,
                                   0xf1, 0x46, 0xbe, 0x00, */
};

/*
  test_case =     2
  key =           "Jefe"
  key_len =       4
  data =          "what do ya want for nothing?"
  data_len =      28
  digest =        0xeffcdf6ae5eb2fa2d27416d5f184df9c259a7c79
*/
static const uint8_t xxx_SHA1_2_key[4] = "Jefe";

static const uint8_t xxx_SHA1_2_text[28] = "what do ya want for nothing?";

static const uint8_t xxx_SHA1_2_hash[] = {
        0xef, 0xfc, 0xdf, 0x6a, 0xe5, 0xeb, 0x2f, 0xa2,
        0xd2, 0x74, 0x16, 0xd5, /* 0xf1, 0x84, 0xdf, 0x9c,
                                   0x25, 0x9a, 0x7c, 0x79, */
};

/*
  test_case =     3
  key =           0xaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
  key_len =       20
  data =          0xdd repeated 50 times
  data_len =      50
  digest =        0x125d7342b9ac11cd91a39af48aa17b4f63f175d3
*/
static const uint8_t xxx_SHA1_3_key[] = {
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa,
};

static const uint8_t xxx_SHA1_3_text[50] = {
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd,
};

static const uint8_t xxx_SHA1_3_hash[] = {
        0x12, 0x5d, 0x73, 0x42, 0xb9, 0xac, 0x11, 0xcd,
        0x91, 0xa3, 0x9a, 0xf4, /* 0x8a, 0xa1, 0x7b, 0x4f,
                                   0x63, 0xf1, 0x75, 0xd3, */
};

/*
  test_case =     4
  key =           0x0102030405060708090a0b0c0d0e0f10111213141516171819
  key_len =       25
  data =          0xcd repeated 50 times
  data_len =      50
  digest =        0x4c9007f4026250c6bc8414f9bf50c86c2d7235da
*/
static const uint8_t xxx_SHA1_4_key[] = {
        0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
        0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10,
        0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
        0x19,
};

static const uint8_t xxx_SHA1_4_text[50] = {
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd,
};

static const uint8_t xxx_SHA1_4_hash[] = {
        0x4c, 0x90, 0x07, 0xf4, 0x02, 0x62, 0x50, 0xc6,
        0xbc, 0x84, 0x14, 0xf9, /* 0xbf, 0x50, 0xc8, 0x6c,
                                   0x2d, 0x72, 0x35, 0xda, */
};

/*
  test_case =     5
  key =           0x0c0c0c0c0c0c0c0c0c0c0c0c0c0c0c0c0c0c0c0c
  key_len =       20
  data =          "Test With Truncation"
  data_len =      20
  digest =        0x4c1a03424b55e07fe7f27be1d58bb9324a9a5a04
  digest-96 =     0x4c1a03424b55e07fe7f27be1
*/
static const uint8_t xxx_SHA1_5_key[] = {
        0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c,
        0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c, 0x0c,
        0x0c, 0x0c, 0x0c, 0x0c,
};

static const uint8_t xxx_SHA1_5_text[20] = "Test With Truncation";

static const uint8_t xxx_SHA1_5_hash[] = {
        0x4c, 0x1a, 0x03, 0x42, 0x4b, 0x55, 0xe0, 0x7f,
        0xe7, 0xf2, 0x7b, 0xe1,
};

/*
  test_case =     6
  key =           0xaa repeated 80 times
  key_len =       80
  data =          "Test Using Larger Than Block-Size Key - Hash Key First"
  data_len =      54
  digest =        0xaa4ae5e15272d00e95705637ce8a3b55ed402112
*/
static const uint8_t xxx_SHA1_6_key[80] = {
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
};

static const uint8_t xxx_SHA1_6_text[54] =
        "Test Using Larger Than Block-Size Key - Hash Key First";

static const uint8_t xxx_SHA1_6_hash[] = {
        0xaa, 0x4a, 0xe5, 0xe1, 0x52, 0x72, 0xd0, 0x0e,
        0x95, 0x70, 0x56, 0x37, /* 0xce, 0x8a, 0x3b, 0x55,
                                   0xed, 0x40, 0x21, 0x12, */
};

/*
   test_case =     7
   key =           0xaa repeated 80 times
   key_len =       80
   data =          "Test Using Larger Than Block-Size Key and Larger
                   Than One Block-Size Data"
   data_len =      73
   digest =        0xe8e99d0f45237d786d6bbaa7965c7808bbff1a91
*/
static const uint8_t xxx_SHA1_7_key[80] = {
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
};

static const uint8_t xxx_SHA1_7_text[73] =
        "Test Using Larger Than Block-Size Key and Larger Than One Block-Size Data";

static const uint8_t xxx_SHA1_7_hash[] = {
        0xe8, 0xe9, 0x9d, 0x0f, 0x45, 0x23, 0x7d, 0x78,
        0x6d, 0x6b, 0xba, 0xa7, /* 0x96, 0x5c, 0x78, 0x08,
                                   0xbb, 0xff, 0x1a, 0x91, */
};

/*
 * https://tools.ietf.org/html/rfc4868
 */
/*
   Test Case AUTH256-1:
   Key =          0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b
                  0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b  (32 bytes)

   Data =         4869205468657265                  ("Hi There")

   PRF-HMAC-SHA-256 = 198a607eb44bfbc69903a0f1cf2bbdc5
                      ba0aa3f3d9ae3c1c7a3b1696a0b68cf7

   HMAC-SHA-256-128 = 198a607eb44bfbc69903a0f1cf2bbdc5
*/

static const uint8_t xxx_256_1_key[] = {
        0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b,
        0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b,
        0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b,
        0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b,
};

static const uint8_t xxx_256_1_text[] = {
        0x48, 0x69, 0x20, 0x54, 0x68, 0x65, 0x72, 0x65,
};

static const uint8_t xxx_256_1_hash[] = {
        0x19, 0x8a, 0x60, 0x7e, 0xb4, 0x4b, 0xfb, 0xc6,
        0x99, 0x03, 0xa0, 0xf1, 0xcf, 0x2b, 0xbd, 0xc5,
};



/*
   Test Case AUTH256-2:
   Key =          4a6566654a6566654a6566654a656665  ("JefeJefeJefeJefe")
                  4a6566654a6566654a6566654a656665  ("JefeJefeJefeJefe")

   Data =         7768617420646f2079612077616e7420  ("what do ya want ")
                  666f72206e6f7468696e673f          ("for nothing?")

   PRF-HMAC-SHA-256 = 167f928588c5cc2eef8e3093caa0e87c
                      9ff566a14794aa61648d81621a2a40c6

   HMAC-SHA-256-128 = 167f928588c5cc2eef8e3093caa0e87c
*/
static const uint8_t xxx_256_2_key[] = {
        0x4a, 0x65, 0x66, 0x65, 0x4a, 0x65, 0x66, 0x65,
        0x4a, 0x65, 0x66, 0x65, 0x4a, 0x65, 0x66, 0x65,
        0x4a, 0x65, 0x66, 0x65, 0x4a, 0x65, 0x66, 0x65,
        0x4a, 0x65, 0x66, 0x65, 0x4a, 0x65, 0x66, 0x65,
};

static const uint8_t xxx_256_2_text[] = {
        0x77, 0x68, 0x61, 0x74, 0x20, 0x64, 0x6f, 0x20,
        0x79, 0x61, 0x20, 0x77, 0x61, 0x6e, 0x74, 0x20,
        0x66, 0x6f, 0x72, 0x20, 0x6e, 0x6f, 0x74, 0x68,
        0x69, 0x6e, 0x67, 0x3f,
};

static const uint8_t xxx_256_2_hash[] = {
        0x16, 0x7f, 0x92, 0x85, 0x88, 0xc5, 0xcc, 0x2e,
        0xef, 0x8e, 0x30, 0x93, 0xca, 0xa0, 0xe8, 0x7c,
};

/*
   Test Case AUTH256-3:
   Key =          aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
                  aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa  (32 bytes)

   Data =         dddddddddddddddddddddddddddddddd
                  dddddddddddddddddddddddddddddddd
                  dddddddddddddddddddddddddddddddd
                  dddd                              (50 bytes)

   PRF-HMAC-SHA-256 = cdcb1220d1ecccea91e53aba3092f962
                      e549fe6ce9ed7fdc43191fbde45c30b0

   HMAC-SHA-256-128 = cdcb1220d1ecccea91e53aba3092f962
*/
static const uint8_t xxx_256_3_key[] = {
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
};

static const uint8_t xxx_256_3_text[] = {
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd,
};

static const uint8_t xxx_256_3_hash[] = {
        0xcd, 0xcb, 0x12, 0x20, 0xd1, 0xec, 0xcc, 0xea,
        0x91, 0xe5, 0x3a, 0xba, 0x30, 0x92, 0xf9, 0x62,
};

/*
   Test Case AUTH256-4:
   Key =          0102030405060708090a0b0c0d0e0f10
                  1112131415161718191a1b1c1d1e1f20  (32 bytes)

   Data =         cdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcd
                  cdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcd
                  cdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcd
                  cdcd                              (50 bytes)

   PRF-HMAC-SHA-256 = 372efcf9b40b35c2115b1346903d2ef4
                      2fced46f0846e7257bb156d3d7b30d3f

   HMAC-SHA-256-128 = 372efcf9b40b35c2115b1346903d2ef4
*/
static const uint8_t xxx_256_4_key[] = {
        0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
        0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10,
        0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
        0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20,
};

static const uint8_t xxx_256_4_text[] = {
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd,
};

static const uint8_t xxx_256_4_hash[] = {
        0x37, 0x2e, 0xfc, 0xf9, 0xb4, 0x0b, 0x35, 0xc2,
        0x11, 0x5b, 0x13, 0x46, 0x90, 0x3d, 0x2e, 0xf4,
};

/*
   Test Case AUTH384-1:
   Key =          0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b
                  0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b
                  0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b  (48 bytes)

   Data =         4869205468657265                  ("Hi There")

   PRF-HMAC-SHA-384 = b6a8d5636f5c6a7224f9977dcf7ee6c7
                      fb6d0c48cbdee9737a959796489bddbc
                      4c5df61d5b3297b4fb68dab9f1b582c2

   HMAC-SHA-384-128 = b6a8d5636f5c6a7224f9977dcf7ee6c7
                      fb6d0c48cbdee973
*/
static const uint8_t xxx_384_1_key[] = {
        0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b,
        0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b,
        0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b,
        0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b,
        0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b,
        0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b,
};

static const uint8_t xxx_384_1_text[] = {
        0x48, 0x69, 0x20, 0x54, 0x68, 0x65, 0x72, 0x65,
};

static const uint8_t xxx_384_1_hash[] = {
        0xb6, 0xa8, 0xd5, 0x63, 0x6f, 0x5c, 0x6a, 0x72,
        0x24, 0xf9, 0x97, 0x7d, 0xcf, 0x7e, 0xe6, 0xc7,
        0xfb, 0x6d, 0x0c, 0x48, 0xcb, 0xde, 0xe9, 0x73,
};

/*
   Test Case AUTH384-2:
   Key =          4a6566654a6566654a6566654a656665  ("JefeJefeJefeJefe")
                  4a6566654a6566654a6566654a656665  ("JefeJefeJefeJefe")
                  4a6566654a6566654a6566654a656665  ("JefeJefeJefeJefe")

   Data =         7768617420646f2079612077616e7420  ("what do ya want ")
                  666f72206e6f7468696e673f          ("for nothing?")

   PRF-HMAC-SHA-384 = 2c7353974f1842fd66d53c452ca42122
                      b28c0b594cfb184da86a368e9b8e16f5
                      349524ca4e82400cbde0686d403371c9

   HMAC-SHA-384-192 = 2c7353974f1842fd66d53c452ca42122
                      b28c0b594cfb184d
*/
static const uint8_t xxx_384_2_key[] = {
        0x4a, 0x65, 0x66, 0x65, 0x4a, 0x65, 0x66, 0x65,
        0x4a, 0x65, 0x66, 0x65, 0x4a, 0x65, 0x66, 0x65,
        0x4a, 0x65, 0x66, 0x65, 0x4a, 0x65, 0x66, 0x65,
        0x4a, 0x65, 0x66, 0x65, 0x4a, 0x65, 0x66, 0x65,
        0x4a, 0x65, 0x66, 0x65, 0x4a, 0x65, 0x66, 0x65,
        0x4a, 0x65, 0x66, 0x65, 0x4a, 0x65, 0x66, 0x65,
};

static const uint8_t xxx_384_2_text[] = {
        0x77, 0x68, 0x61, 0x74, 0x20, 0x64, 0x6f, 0x20,
        0x79, 0x61, 0x20, 0x77, 0x61, 0x6e, 0x74, 0x20,
        0x66, 0x6f, 0x72, 0x20, 0x6e, 0x6f, 0x74, 0x68,
        0x69, 0x6e, 0x67, 0x3f,
};

static const uint8_t xxx_384_2_hash[] = {
        0x2c, 0x73, 0x53, 0x97, 0x4f, 0x18, 0x42, 0xfd,
        0x66, 0xd5, 0x3c, 0x45, 0x2c, 0xa4, 0x21, 0x22,
        0xb2, 0x8c, 0x0b, 0x59, 0x4c, 0xfb, 0x18, 0x4d,
};

/*
   Test Case AUTH384-3:
   Key =          aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
                  aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
                  aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa  (48 bytes)

   Data =         dddddddddddddddddddddddddddddddd
                  dddddddddddddddddddddddddddddddd
                  dddddddddddddddddddddddddddddddd
                  dddd                              (50 bytes)

   PRF-HMAC-SHA-384 = 809f439be00274321d4a538652164b53
                      554a508184a0c3160353e3428597003d
                      35914a18770f9443987054944b7c4b4a

   HMAC-SHA-384-192 = 809f439be00274321d4a538652164b53
                      554a508184a0c316
*/
static const uint8_t xxx_384_3_key[] = {
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
};

static const uint8_t xxx_384_3_text[] = {
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd,
};

static const uint8_t xxx_384_3_hash[] = {
        0x80, 0x9f, 0x43, 0x9b, 0xe0, 0x02, 0x74, 0x32,
        0x1d, 0x4a, 0x53, 0x86, 0x52, 0x16, 0x4b, 0x53,
        0x55, 0x4a, 0x50, 0x81, 0x84, 0xa0, 0xc3, 0x16,
};

/*
   Test Case AUTH384-4:
   Key =          0102030405060708090a0b0c0d0e0f10
                  1112131415161718191a1b1c1d1e1f20
                  0a0b0c0d0e0f10111213141516171819  (48 bytes)

   Data =         cdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcd
                  cdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcd
                  cdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcd
                  cdcd                              (50 bytes)

   PRF-HMAC-SHA-384 = 5b540085c6e6358096532b2493609ed1
                      cb298f774f87bb5c2ebf182c83cc7428
                      707fb92eab2536a5812258228bc96687

   HMAC-SHA-384-192 = 5b540085c6e6358096532b2493609ed1
                      cb298f774f87bb5c
*/
static const uint8_t xxx_384_4_key[] = {
        0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
        0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10,
        0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
        0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20,
        0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10, 0x11,
        0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19,
};

static const uint8_t xxx_384_4_text[] = {
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd,
};

static const uint8_t xxx_384_4_hash[] = {
        0x5b, 0x54, 0x00, 0x85, 0xc6, 0xe6, 0x35, 0x80,
        0x96, 0x53, 0x2b, 0x24, 0x93, 0x60, 0x9e, 0xd1,
        0xcb, 0x29, 0x8f, 0x77, 0x4f, 0x87, 0xbb, 0x5c,
};

/*
   Test Case AUTH512-1:
   Key =          0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b
                  0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b
                  0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b
                  0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b0b  (64 bytes)

   Data =         4869205468657265                  ("Hi There")

   PRF-HMAC-SHA-512 = 637edc6e01dce7e6742a99451aae82df
                      23da3e92439e590e43e761b33e910fb8
                      ac2878ebd5803f6f0b61dbce5e251ff8
                      789a4722c1be65aea45fd464e89f8f5b

   HMAC-SHA-512-256 = 637edc6e01dce7e6742a99451aae82df
                      23da3e92439e590e43e761b33e910fb8
*/
static const uint8_t xxx_512_1_key[] = {
        0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b,
        0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b,
        0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b,
        0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b,
        0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b,
        0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b,
        0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b,
        0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0b,
};

static const uint8_t xxx_512_1_text[] = {
        0x48, 0x69, 0x20, 0x54, 0x68, 0x65, 0x72, 0x65,
};

static const uint8_t xxx_512_1_hash[] = {
        0x63, 0x7e, 0xdc, 0x6e, 0x01, 0xdc, 0xe7, 0xe6,
        0x74, 0x2a, 0x99, 0x45, 0x1a, 0xae, 0x82, 0xdf,
        0x23, 0xda, 0x3e, 0x92, 0x43, 0x9e, 0x59, 0x0e,
        0x43, 0xe7, 0x61, 0xb3, 0x3e, 0x91, 0x0f, 0xb8,
};

/*
   Test Case AUTH512-2:
   Key =          4a6566654a6566654a6566654a656665  ("JefeJefeJefeJefe")
                  4a6566654a6566654a6566654a656665  ("JefeJefeJefeJefe")
                  4a6566654a6566654a6566654a656665  ("JefeJefeJefeJefe")
                  4a6566654a6566654a6566654a656665  ("JefeJefeJefeJefe")

   Data =         7768617420646f2079612077616e7420  ("what do ya want ")
                  666f72206e6f7468696e673f          ("for nothing?")

   PRF-HMAC-SHA-512 = cb370917ae8a7ce28cfd1d8f4705d614
                      1c173b2a9362c15df235dfb251b15454
                      6aa334ae9fb9afc2184932d8695e397b
                      fa0ffb93466cfcceaae38c833b7dba38

   HMAC-SHA-512-256 = cb370917ae8a7ce28cfd1d8f4705d614
                      1c173b2a9362c15df235dfb251b15454
*/
static const uint8_t xxx_512_2_key[] = {
        0x4a, 0x65, 0x66, 0x65, 0x4a, 0x65, 0x66, 0x65,
        0x4a, 0x65, 0x66, 0x65, 0x4a, 0x65, 0x66, 0x65,
        0x4a, 0x65, 0x66, 0x65, 0x4a, 0x65, 0x66, 0x65,
        0x4a, 0x65, 0x66, 0x65, 0x4a, 0x65, 0x66, 0x65,
        0x4a, 0x65, 0x66, 0x65, 0x4a, 0x65, 0x66, 0x65,
        0x4a, 0x65, 0x66, 0x65, 0x4a, 0x65, 0x66, 0x65,
        0x4a, 0x65, 0x66, 0x65, 0x4a, 0x65, 0x66, 0x65,
        0x4a, 0x65, 0x66, 0x65, 0x4a, 0x65, 0x66, 0x65,
};

static const uint8_t xxx_512_2_text[] = {
        0x77, 0x68, 0x61, 0x74, 0x20, 0x64, 0x6f, 0x20,
        0x79, 0x61, 0x20, 0x77, 0x61, 0x6e, 0x74, 0x20,
        0x66, 0x6f, 0x72, 0x20, 0x6e, 0x6f, 0x74, 0x68,
        0x69, 0x6e, 0x67, 0x3f,
};

static const uint8_t xxx_512_2_hash[] = {
        0xcb, 0x37, 0x09, 0x17, 0xae, 0x8a, 0x7c, 0xe2,
        0x8c, 0xfd, 0x1d, 0x8f, 0x47, 0x05, 0xd6, 0x14,
        0x1c, 0x17, 0x3b, 0x2a, 0x93, 0x62, 0xc1, 0x5d,
        0xf2, 0x35, 0xdf, 0xb2, 0x51, 0xb1, 0x54, 0x54,
};

/*
   Test Case AUTH512-3:
   Key =          aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
                  aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
                  aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
                  aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa  (64 bytes)

   Data =         dddddddddddddddddddddddddddddddd
                  dddddddddddddddddddddddddddddddd
                  dddddddddddddddddddddddddddddddd
                  dddd                              (50 bytes)

   PRF-HMAC-SHA-512 = 2ee7acd783624ca9398710f3ee05ae41
                      b9f9b0510c87e49e586cc9bf961733d8
                      623c7b55cebefccf02d5581acc1c9d5f
                      b1ff68a1de45509fbe4da9a433922655

   HMAC-SHA-512-256 = 2ee7acd783624ca9398710f3ee05ae41
                      b9f9b0510c87e49e586cc9bf961733d8
*/
static const uint8_t xxx_512_3_key[] = {
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
        0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa, 0xaa,
};

static const uint8_t xxx_512_3_text[] = {
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd, 0xdd,
        0xdd, 0xdd,
};

static const uint8_t xxx_512_3_hash[] = {
        0x2e, 0xe7, 0xac, 0xd7, 0x83, 0x62, 0x4c, 0xa9,
        0x39, 0x87, 0x10, 0xf3, 0xee, 0x05, 0xae, 0x41,
        0xb9, 0xf9, 0xb0, 0x51, 0x0c, 0x87, 0xe4, 0x9e,
        0x58, 0x6c, 0xc9, 0xbf, 0x96, 0x17, 0x33, 0xd8,
};

/*
   Test Case AUTH512-4:
   Key =          0a0b0c0d0e0f10111213141516171819
                  0102030405060708090a0b0c0d0e0f10
                  1112131415161718191a1b1c1d1e1f20
                  2122232425262728292a2b2c2d2e2f30
                  3132333435363738393a3b3c3d3e3f40  (64 bytes)

   Data =         cdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcd
                  cdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcd
                  cdcdcdcdcdcdcdcdcdcdcdcdcdcdcdcd
                  cdcd                              (50 bytes)

   PRF-HMAC-SHA-512 = 5e6688e5a3daec826ca32eaea224eff5
                      e700628947470e13ad01302561bab108
                      b8c48cbc6b807dcfbd850521a685babc
                      7eae4a2a2e660dc0e86b931d65503fd2

   HMAC-SHA-512-256 = 5e6688e5a3daec826ca32eaea224eff5
                      e700628947470e13ad01302561bab108
*/
static const uint8_t xxx_512_4_key[] = {
        0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08,
        0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f, 0x10,
        0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18,
        0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f, 0x20,
        0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28,
        0x29, 0x2a, 0x2b, 0x2c, 0x2d, 0x2e, 0x2f, 0x30,
        0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38,
        0x39, 0x3a, 0x3b, 0x3c, 0x3d, 0x3e, 0x3f, 0x40,
};

static const uint8_t xxx_512_4_text[] = {
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd, 0xcd,
        0xcd, 0xcd,
};

static const uint8_t xxx_512_4_hash[] = {
        0x5e, 0x66, 0x88, 0xe5, 0xa3, 0xda, 0xec, 0x82,
        0x6c, 0xa3, 0x2e, 0xae, 0xa2, 0x24, 0xef, 0xf5,
        0xe7, 0x00, 0x62, 0x89, 0x47, 0x47, 0x0e, 0x13,
        0xad, 0x01, 0x30, 0x25, 0x61, 0xba, 0xb1, 0x08,
};

/*
 * https://tools.ietf.org/html/rfc3566
 */
/*
   Test Case #1   : AES-XCBC-MAC-96 with 0-byte input
   Key (K)        : 000102030405060708090a0b0c0d0e0f
   Message (M)    : <empty string>
   AES-XCBC-MAC   : 75f0251d528ac01c4573dfd584d79f29
   AES-XCBC-MAC-96: 75f0251d528ac01c4573dfd5
*/
static const uint8_t xxx_XCBC_1_key[] = {
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
        0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,
};

static const uint8_t xxx_XCBC_1_text[] = {
        /* empty */
};

static const uint8_t xxx_XCBC_1_hash[] = {
        0x75, 0xf0, 0x25, 0x1d, 0x52, 0x8a, 0xc0, 0x1c,
        0x45, 0x73, 0xdf, 0xd5,
};

/*
   Test Case #2   : AES-XCBC-MAC-96 with 3-byte input
   Key (K)        : 000102030405060708090a0b0c0d0e0f
   Message (M)    : 000102
   AES-XCBC-MAC   : 5b376580ae2f19afe7219ceef172756f
   AES-XCBC-MAC-96: 5b376580ae2f19afe7219cee
*/
static const uint8_t xxx_XCBC_2_key[] = {
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
        0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,
};

static const uint8_t xxx_XCBC_2_text[] = {
        0x00, 0x01, 0x02,
};

static const uint8_t xxx_XCBC_2_hash[] = {
        0x5b, 0x37, 0x65, 0x80, 0xae, 0x2f, 0x19, 0xaf,
        0xe7, 0x21, 0x9c, 0xee,
};

/*
   Test Case #3   : AES-XCBC-MAC-96 with 16-byte input
   Key (K)        : 000102030405060708090a0b0c0d0e0f
   Message (M)    : 000102030405060708090a0b0c0d0e0f
   AES-XCBC-MAC   : d2a246fa349b68a79998a4394ff7a263
   AES-XCBC-MAC-96: d2a246fa349b68a79998a439
*/
static const uint8_t xxx_XCBC_3_key[] = {
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
        0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,
};

static const uint8_t xxx_XCBC_3_text[] = {
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
        0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,
};

static const uint8_t xxx_XCBC_3_hash[] = {
        0xd2, 0xa2, 0x46, 0xfa, 0x34, 0x9b, 0x68, 0xa7,
        0x99, 0x98, 0xa4, 0x39,
};
/*
   Test Case #4   : AES-XCBC-MAC-96 with 20-byte input
   Key (K)        : 000102030405060708090a0b0c0d0e0f
   Message (M)    : 000102030405060708090a0b0c0d0e0f10111213
   AES-XCBC-MAC   : 47f51b4564966215b8985c63055ed308
   AES-XCBC-MAC-96: 47f51b4564966215b8985c63
*/
static const uint8_t xxx_XCBC_4_key[] = {
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
        0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,
};

static const uint8_t xxx_XCBC_4_text[] = {
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
        0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,
        0x10, 0x11, 0x12, 0x13,
};

static const uint8_t xxx_XCBC_4_hash[] = {
        0x47, 0xf5, 0x1b, 0x45, 0x64, 0x96, 0x62, 0x15,
        0xb8, 0x98, 0x5c, 0x63,
};
/*
   Test Case #5   : AES-XCBC-MAC-96 with 32-byte input
   Key (K)        : 000102030405060708090a0b0c0d0e0f
   Message (M)    : 000102030405060708090a0b0c0d0e0f10111213141516171819
                    1a1b1c1d1e1f
   AES-XCBC-MAC   : f54f0ec8d2b9f3d36807734bd5283fd4
   AES-XCBC-MAC-96: f54f0ec8d2b9f3d36807734b
*/
static const uint8_t xxx_XCBC_5_key[] = {
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
        0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,
};

static const uint8_t xxx_XCBC_5_text[] = {
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
        0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,
        0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17,
        0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f,
};

static const uint8_t xxx_XCBC_5_hash[] = {
        0xf5, 0x4f, 0x0e, 0xc8, 0xd2, 0xb9, 0xf3, 0xd3,
        0x68, 0x07, 0x73, 0x4b,
};

/*
   Test Case #6   : AES-XCBC-MAC-96 with 34-byte input
   Key (K)        : 000102030405060708090a0b0c0d0e0f
   Message (M)    : 000102030405060708090a0b0c0d0e0f10111213141516171819
                    1a1b1c1d1e1f2021
   AES-XCBC-MAC   : becbb3bccdb518a30677d5481fb6b4d8
   AES-XCBC-MAC-96: becbb3bccdb518a30677d548
*/
static const uint8_t xxx_XCBC_6_key[] = {
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
        0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,
};

static const uint8_t xxx_XCBC_6_text[] = {
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
        0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,
        0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17,
        0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f,
        0x20, 0x21,
};

static const uint8_t xxx_XCBC_6_hash[] = {
        0xbe, 0xcb, 0xb3, 0xbc, 0xcd, 0xb5, 0x18, 0xa3,
        0x06, 0x77, 0xd5, 0x48,
};

/*
   Test Case #7   : AES-XCBC-MAC-96 with 1000-byte input
   Key (K)        : 000102030405060708090a0b0c0d0e0f
   Message (M)    : 00000000000000000000 ... 00000000000000000000
                    [1000 bytes]
   AES-XCBC-MAC   : f0dafee895db30253761103b5d84528f
   AES-XCBC-MAC-96: f0dafee895db30253761103b
*/
static const uint8_t xxx_XCBC_7_key[] = {
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
        0x08, 0x09, 0x0a, 0x0b, 0x0c, 0x0d, 0x0e, 0x0f,
};

static const uint8_t xxx_XCBC_7_text[1000] = {
        0,
};

static const uint8_t xxx_XCBC_7_hash[] = {
        0xf0, 0xda, 0xfe, 0xe8, 0x95, 0xdb, 0x30, 0x25,
        0x37, 0x61, 0x10, 0x3b,
};


struct hmac_params {
        JOB_HASH_ALG   algo;
        const uint8_t *key;
        size_t         key_len;
        const uint8_t *text;
        size_t         text_len;
        const uint8_t *hash;
        size_t         hash_len;
};

#define HMAC_PARAMS_SET(name,_algo)               \
{                                                 \
        .algo     = (_algo),                      \
        .key      = name##_key,                   \
        .key_len  = sizeof(name##_key),           \
        .text     = name##_text,                  \
        .text_len = sizeof(name##_text),          \
        .hash     = name##_hash,                  \
        .hash_len = sizeof(name##_hash),          \
}

static const struct hmac_params HMAC_PARAMS[] = {
        HMAC_PARAMS_SET(xxx_XCBC_1, AES_XCBC),
        HMAC_PARAMS_SET(xxx_XCBC_2, AES_XCBC),
        HMAC_PARAMS_SET(xxx_XCBC_3, AES_XCBC),
        HMAC_PARAMS_SET(xxx_XCBC_4, AES_XCBC),
        HMAC_PARAMS_SET(xxx_XCBC_5, AES_XCBC),
        HMAC_PARAMS_SET(xxx_XCBC_6, AES_XCBC),
        HMAC_PARAMS_SET(xxx_XCBC_7, AES_XCBC),

        HMAC_PARAMS_SET(xxx_SHA1_1, SHA1),
        HMAC_PARAMS_SET(xxx_SHA1_2, SHA1),
        HMAC_PARAMS_SET(xxx_SHA1_3, SHA1),
        HMAC_PARAMS_SET(xxx_SHA1_4, SHA1),
        HMAC_PARAMS_SET(xxx_SHA1_5, SHA1),
        HMAC_PARAMS_SET(xxx_SHA1_6, SHA1),
        HMAC_PARAMS_SET(xxx_SHA1_7, SHA1),

        HMAC_PARAMS_SET(xxx_256_1, SHA_256),
        HMAC_PARAMS_SET(xxx_256_2, SHA_256),
        HMAC_PARAMS_SET(xxx_256_3, SHA_256),
        HMAC_PARAMS_SET(xxx_256_4, SHA_256),

        HMAC_PARAMS_SET(xxx_384_1, SHA_384),
        HMAC_PARAMS_SET(xxx_384_2, SHA_384),
        HMAC_PARAMS_SET(xxx_384_3, SHA_384),
        HMAC_PARAMS_SET(xxx_384_4, SHA_384),

        HMAC_PARAMS_SET(xxx_512_1, SHA_512),
        HMAC_PARAMS_SET(xxx_512_2, SHA_512),
        HMAC_PARAMS_SET(xxx_512_3, SHA_512),
        HMAC_PARAMS_SET(xxx_512_4, SHA_512),
};

static inline void
key_expand_block(void (*one_block_hash)(const void *src, void *dst),
                 void *dst,
                 uint8_t pad,
                 unsigned block_size,
                 const uint8_t *key,
                 unsigned key_len)
{
        uint8_t buf[block_size] __attribute__((aligned(16)));
        unsigned i;

        /* XXX: MUST key_len <= block_size */
        memset(buf, pad, block_size);
        for (i = 0; i < key_len; i++)
                buf[i] ^= key[i];
        one_block_hash(buf, dst);
        memset(buf, 0, block_size);
}

static enum result_e
key_expand(const struct handler_s *handler,
           JOB_HASH_ALG algo,
           const uint8_t *key,
           unsigned key_len,
           union expkey_u *expkey)
{
        switch (algo) {
        case SHA1:
                if (key_len > 64)
                        return SKIP;
                key_expand_block(handler->sha1, expkey->ipad, 0x36, 64, key, key_len);
                key_expand_block(handler->sha1, expkey->opad, 0x5c, 64, key, key_len);
                break;
        case SHA_256:
                if (key_len > 64)
                        return SKIP;
                key_expand_block(handler->sha256, expkey->ipad, 0x36, 64, key, key_len);
                key_expand_block(handler->sha256, expkey->opad, 0x5c, 64, key, key_len);
                break;
        case SHA_384:
                if (key_len > 128)
                        return SKIP;
                key_expand_block(handler->sha384, expkey->ipad, 0x36, 128, key, key_len);
                key_expand_block(handler->sha384, expkey->opad, 0x5c, 128, key, key_len);
                break;
        case SHA_512:
                if (key_len > 128)
                        return SKIP;
                key_expand_block(handler->sha512, expkey->ipad, 0x36, 128, key, key_len);
                key_expand_block(handler->sha512, expkey->opad, 0x5c, 128, key, key_len);
                break;
        case AES_XCBC:
                if (key_len != 16)
                        return FAIL;
                handler->keyexp_xcbc(key, expkey->k1, expkey->k2, expkey->k3);
                break;
        default:
                return FAIL;
        }
        return OK;
}

static enum result_e
do_test(const struct handler_s *handler,
        JOB_HASH_ALG algo,
        const union expkey_u *expkey,
        uint8_t *text,
        size_t text_len,
        const void *tag_chk,
        size_t tag_len)
{
        uint8_t tag[tag_len];
        struct JOB_AES_HMAC *job;
        enum result_e ret = FAIL;
        struct MB_MGR mb_mgr;

        handler->init_mb_mgr(&mb_mgr);

        job = handler->get_next_job(&mb_mgr);

        job->cipher_direction = ENCRYPT;
        job->chain_order = CIPHER_HASH;
        job->dst = text;
        job->src = text;
        job->cipher_mode = NULL_CIPHER;
        job->aes_enc_key_expanded = NULL;
        job->aes_dec_key_expanded = NULL;
        job->aes_key_len_in_bytes = 0;
        job->iv = NULL;
        job->iv_len_in_bytes = 0;
        job->cipher_start_src_offset_in_bytes = 0;
        job->msg_len_to_cipher_in_bytes = 0;
        job->hash_alg = algo;
        job->hash_start_src_offset_in_bytes = 0;
        job->msg_len_to_hash_in_bytes = text_len;
        job->auth_tag_output = tag;
        job->auth_tag_output_len_in_bytes = tag_len;

        switch (algo) {
        case SHA1:
        case SHA_256:
        case SHA_384:
        case SHA_512:
                job->hashed_auth_key_xor_ipad = expkey->ipad;
                job->hashed_auth_key_xor_opad = expkey->opad;
                break;
        case AES_XCBC:
                job->_k1_expanded = expkey->k1;
                job->_k2 = expkey->k2;
                job->_k3 = expkey->k3;
                break;
        default:
                FPRINTF(stderr, "invalid algorithm\n");
                goto end;
        }

        job = handler->submit_job(&mb_mgr);
        if (job) {
                FPRINTF(stderr, "Unexpected return from submit_job status:%d\n",
                        job->status);
                goto end;
        }
        job = handler->flush_job(&mb_mgr);
        if (!job) {
                FPRINTF(stderr, "Unexpected null return from flush_job\n");
                goto end;
        } else if (job->status != STS_COMPLETED) {
                FPRINTF(stderr, "Error status:%d\n", job->status);
                goto end;
        }

        if (memcmp(tag, tag_chk, tag_len)) {
                FPRINTF(stderr, "mismatched\n");
                goto end;
        }
        ret = OK;
 end:
        while ((job = handler->flush_job(&mb_mgr)) != NULL)
                ;
        return ret;
}

static const char *AlgoNmae[] = {
        [SHA1] = "SHA1",
        [SHA_256] = "SHA256",
        [SHA_384] = "SHA384",
        [SHA_512] = "SHA512",
        [AES_XCBC] = "AES_XCBC",
};

/*
 *
 */
int
hmac_test(enum capability_e cap)
{
        int results[NB_RESULTS];
        unsigned i;
        const struct handler_s *handler = get_handler(cap);

        memset(results, 0, sizeof(results));

        FPRINTF(stderr, "Testing HMAC\n");

        for (i = 0; i < ARRAYOF(HMAC_PARAMS); i++) {
                union expkey_u key __attribute__((aligned(16)));
                uint8_t data[1024];
                enum result_e ret;

                FPRINTF(stderr, "%uth algo:%s key:%zu txt:%zu hash:%zu ...",
                        i + 1,
                        AlgoNmae[HMAC_PARAMS[i].algo],
                        HMAC_PARAMS[i].key_len,
                        HMAC_PARAMS[i].text_len,
                        HMAC_PARAMS[i].hash_len);

                if (sizeof(data) <  HMAC_PARAMS[i].text_len) {
                        FPRINTF(stderr, "invalid params, too long text\n");
                        results[FAIL]++;
                        continue;
                }

                if (!HMAC_PARAMS[i].text_len) {
                        FPRINTF(stderr, "Unsupported NULL Text\n");
                        results[SKIP]++;
                        continue;
                }

                ret = key_expand(handler,
                                 HMAC_PARAMS[i].algo,
                                 HMAC_PARAMS[i].key, HMAC_PARAMS[i].key_len,
                                 &key);
                results[ret]++;
                switch (ret) {
                case OK:
                        break;
                case SKIP:
                        FPRINTF(stderr, "not supported algo\n");
                        continue;
                case FAIL:
                default:
                        FPRINTF(stderr, "failed key expand\n");
                        continue;
                }

                memcpy(data, HMAC_PARAMS[i].text, HMAC_PARAMS[i].text_len);
                ret = do_test(handler,
                              HMAC_PARAMS[i].algo,
                              &key,
                              data, HMAC_PARAMS[i].text_len,
                              HMAC_PARAMS[i].hash, HMAC_PARAMS[i].hash_len);
                results[ret]++;
                switch (ret) {
                case OK:
                        FPRINTF(stderr, "Ok\n");
                        break;
                case SKIP:
                        FPRINTF(stderr, "Not supported\n");
                        continue;
                case FAIL:
                        break;
                default:
                        FPRINTF(stderr, "Failed\n");
                        continue;
                }
        }

        FPRINTF(stderr, "Ok:%d Fail:%d Skip:%d\n",
                results[OK], results[FAIL], results[SKIP]);
        return results[FAIL] ? -1 : 0;
}

